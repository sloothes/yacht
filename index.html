<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Editor Yatch (alpha 0.1.1)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/ecs/js/TabUI.js"></script>

		<script>
			const debugMode = true;
			const Signal = signals.Signal;
			const RAD2DEG = 57.29577951308232;
			const DEG2RAD = 0.017453292519943295;
			document.body.appendChild( createSidePanel() );
		</script>

		<script src="/ecs/js/three.js"></script>
		<script src="/ecs/js/MeshWalk.js"></script>
		<script src="/ecs/js/UVsDebug.js"></script>
		<script src="/ecs/js/FBXLoader.js"></script>
		<script src="/ecs/js/VirtualInput.js"></script>
		<script src="/ecs/js/KeyboardState.js"></script>
		<script src="/ecs/js/EditorControls.js"></script>
		<script src="/ecs/js/camera-controls.js"></script>
		<script src="/ecs/js/SubdivisionModifier.js"></script>
		<script src="/ecs/js/three-pathfinding.umd.js"></script>

		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

	<!-- Water.js -->

		<script src="/three/Ocean_fft.js"></script>
		<script src="/three/MirrorRenderer.js"></script>
		<script src="/three/WaterMaterial.js"></script>

	<!-- Engine.js -->

		<script src="/ecs/engine/core/helpers.js"></script>
		<script src="/ecs/engine/core/keyboard.js"></script>
		<script src="/ecs/engine/core/enviroment.js"></script>
		<script src="/ecs/engine/core/localPlayer.js"></script>
		<script src="/ecs/engine/core/cameraControls.js"></script>
		<script src="/ecs/engine/core/keyboardState.js"></script>
		<script src="/ecs/engine/core/keyInputControls.js"></script>
		<script src="/ecs/engine/core/joystickControls.js"></script>

	<!-- Editor.js -->

		<script src="/yatch/editor/EntityManager.js"></script>
		<script src="/yatch/editor/MaterialManager.js"></script>
		<script src="/yatch/editor/TexturesManager.js"></script>
		<script src="/yatch/editor/UndoArray.js"></script>
		<script	src="/yatch/editor/editor-tab-ui.js"></script>
		<script	src="/yatch/editor/geometry-tab-ui.js"></script>
		<script	src="/yatch/editor/material-tab-ui.js"></script>
		<script	src="/yatch/editor/textures-tab-ui.js"></script>
		<script src="/yatch/editor/watchers-call-ui.js"></script>
		<script src="/yatch/editor/entities-helpers.js"></script>
		<script src="/yatch/editor/TextureEditor.js"></script>
		<script src="/yatch/editor/MaterialEditor.js"></script>
		<script src="/yatch/editor/Object3DEditor.js"></script>
		<script src="/yatch/editor/RigidObjects.js"></script>
		<script src="/yatch/editor/editor-droplists.js"></script>
		<script src="/yatch/editor/edges-helper.js"></script>
		<script src="/yatch/editor/octree-helpers.js"></script>
		<script src="/yatch/editor/geometry-buttons.js"></script>
		<script src="/yatch/editor/editor-buttons.js"></script>
		<script src="/yatch/editor/rigid-objects-buttons.js"></script>
		<script src="/yatch/editor/editor-key-inputs.js"></script>
		<script src="/yatch/editor/editor-mouse-inputs.js"></script>
		<script src="/yatch/editor/editor-manager.js"></script>
		<script src="/yatch/editor/editor-systems.js"></script>

	<!-- script src="/yatch/editor/MaterialTab.js"></script -->
	<!-- script src="/yatch/editor/TexturesTab.js"></script -->

		<script>

		//	material-map-droplist.js

			(function(editor,map_droplist,vector_x,vector_y,vector_droplist){

				watch( map_droplist, "onchange", function( property, event, map ){

					var key = vector_droplist.value;

					if ( map !== "normalMap" )         [vector_x.value, vector_y.value] = ["",""];
					else if ( key !== "normalScale" )  [vector_x.value, vector_y.value] = ["",""];
					else if ( editor[map] == null)     [vector_x.value, vector_y.value] = ["",""];
					else if ( editor[key] == null)     [vector_x.value, vector_y.value] = ["",""];
					else if ( !editor[map].isTexture ) [vector_x.value, vector_y.value] = ["",""];
					else if ( !editor[key].isVector2 ) [vector_x.value, vector_y.value] = ["",""];
					else [ vector_x.value, vector_y.value ] = [ editor[key].x.toFixed(2), editor[key].y.toFixed(2) ];

				});

			//	Update texture entities droplist.
				watch( map_droplist, "onchange", function( property, event, map ){
					var entity_droplist = document.querySelector("select#textures-entities-droplist"); // texture editor droplist.
					entity_droplist && editor[map] && callWatchers( entity_droplist, "onchange", "change", entity_droplist = String(editor[map].id) );
				});

			})(
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("select#material-map-droplist"), // map_droplist.
				TabUI.Material.tab.querySelector("input#material-vector-x-input"),  // vector_x,
				TabUI.Material.tab.querySelector("input#material-vector-y-input"),  // vector_y,
				TabUI.Material.tab.querySelector("select#material-vector-droplist") // vector_droplist.
			);


		//	material-key-droplist.js

			(function(editor,text_input,value_input,key_droplist){

				const RAD2DEG = 57.29577951308232;
				const DEG2RAD = 0.017453292519943295;

				watch( key_droplist, "onchange", function( property, event, key ){

					if ( key !== "" && editor[key] !== undefined ) {

						switch ( typeof editor[key] ) {

							case "string":
								[text_input.value, value_input.value] = [ editor[key], "" ];
							break;
						//
							case "number":

								if ( key === "rotation" ) {
									[value_input.value, text_input.value] = [ (RAD2DEG*editor[key]).toFixed(1), "" ]; break;
								}

								else if ( ("displacementScale,polygonOffsetUnits,polygonOffsetFactor,opacity,"
								+ "alphaTest,reflectivity,refractionRatio,bumpScale,metalness,roughness,displacementBias,"
								+ "aoMapIntensity,envMapIntensity,emissiveIntensity,lightMapIntensity,wireframeLinewidth,"
								+ "linewidth,size,scale,gapSize,dashSize,shininess").split(",").includes(key) ) {

									[value_input.value, text_input.value] = [ editor[key].toFixed(2), "" ]; break;
								}

								else [value_input.value, text_input.value] = [ editor[key].toFixed(0), "" ];

							break;
						//
							case "boolean":
								[text_input.value, value_input.value] = [ "", editor[key] ];
							break;
						//
							default:
								[ value_input.value, text_input.value ] = ["",""];
							break;
						}

					} 

					else [ value_input.value, text_input.value ] = ["",""];

				});

			})(
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-text-input"), // text_input,
				TabUI.Material.tab.querySelector("input#material-value-input"), // value_input,
				TabUI.Material.tab.querySelector("select#material-keys-droplist") // key_droplist.
			);


		//	material-vector-droplist.js

			(function(editor,vector_x,vector_y,vector_droplist){

				watch( vector_droplist, "onchange", function( property, event, key ){

					if ( key === "" )                         [vector_x.value, vector_y.value] = ["",""];
					else if ( editor[key] === undefined )     [vector_x.value, vector_y.value] = ["",""];
					else if ( !editor[key].isVector2 )        [vector_x.value, vector_y.value] = ["",""];
					else [ vector_x.value, vector_y.value ] = [ editor[key].x.toFixed(2), editor[key].y.toFixed(2) ];

				});

			})(
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-vector-x-input"),  // vector_x,
				TabUI.Material.tab.querySelector("input#material-vector-y-input"),  // vector_y,
				TabUI.Material.tab.querySelector("select#material-vector-droplist") // vector_droplist.
			);


		//	material-color-droplist.js

			(function(editor,color_r,color_g,color_b,color_droplist){

				watch( color_droplist, "onchange", function( property, event, key ){

					if ( key === "" )                     [color_r.value, color_g.value, color_b.value] = ["","",""];
					else if ( editor[key] === undefined ) [color_r.value, color_g.value, color_b.value] = ["","",""];
					else if ( !editor[key].isColor )      [color_r.value, color_g.value, color_b.value] = ["","",""];

					else [ color_r.value, color_g.value, color_b.value ] = [ 
						parseInt( 255*editor[ key ].r ).toFixed(0),
						parseInt( 255*editor[ key ].g ).toFixed(0),
						parseInt( 255*editor[ key ].b ).toFixed(0)
					];

				});

			})(
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-color-r-input"), // color_r,
				TabUI.Material.tab.querySelector("input#material-color-g-input"), // color_g,
				TabUI.Material.tab.querySelector("input#material-color-b-input"), // color_b,
				TabUI.Material.tab.querySelector("select#material-color-droplist") // color_droplist.
			);


		//	material-entity-droplist.js

			(function(editor,map_droplist,key_droplist,vector_droplist,color_droplist,entity_droplist,exitEditMode){

				watch( entity_droplist, "onchange", function( property, event, value ){

					editor.update( value );

				//	Call droplist watchers.

					callWatchers( map_droplist, "onchange", "change", map_droplist.value );
					callWatchers( key_droplist, "onchange", "change", key_droplist.value );
					callWatchers( vector_droplist, "onchange", "change", vector_droplist.value );
					callWatchers( color_droplist, "onchange", "change", color_droplist.value );

				});

			})(
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("select#material-map-droplist"),      // map_droplist.
				TabUI.Material.tab.querySelector("select#material-keys-droplist"),     // key_droplist.
				TabUI.Material.tab.querySelector("select#material-vector-droplist"),   // vector_droplist.
				TabUI.Material.tab.querySelector("select#material-color-droplist"),    // vector_droplist.
				TabUI.Material.tab.querySelector("select#material-entities-droplist"), // entity_droplist.
				exitEditMode   // function.
			);

		</script>

		<script>

		//	material-manager.js

		//	Type. (DONT CHANGE MATERIAL TYPE).

			(function( editor,text_input,value_input,key_droplist,type_droplist ){

				watch( editor, "type", function( key, action, value ){
					type_droplist.value = value; // dummy droplist.
					if ( key_droplist.value === key ) text_input.value = value;
				});

			})( 
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-text-input"),     // text_input,
				TabUI.Material.tab.querySelector("input#material-value-input"),    // value_input,
				TabUI.Material.tab.querySelector("select#material-keys-droplist"), // key_droplist,
				TabUI.Material.tab.querySelector("select#material-type-droplist")  // type_droplist
			);

		//	Vectors.

			(function( editor,vector_x,vector_y,vector_droplist,entity_droplist ){

				var material;

				watch( entity_droplist, "onchange", function( property, event, value ){
					material = getMaterialByEntityId( value );
				});

				var vector = { x:vector_x, y:vector_y };

			//	normalScale.

				watch( editor.normalScale,  function( key, action, value ){
				//	var material = getMaterialByEntityId(); // console.log(material);
				//	debugMode && console.log({property:"color",key:key,value:value});
					if (material && material.normalScale) material.normalScale[key] = Number(value);
					if ( vector_droplist.value === "normalScale" ) vector[key].value = value.toFixed(2);
				});

			})( 
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-vector-x-input"),    // vector_x,
				TabUI.Material.tab.querySelector("input#material-vector-y-input"),    // vector_y,
				TabUI.Material.tab.querySelector("select#material-vector-droplist"),  // vector_droplist,
				TabUI.Material.tab.querySelector("select#material-entities-droplist") // entity_droplist,
			);

		//	Colors.

			(function( editor,color_r,color_g,color_b,color_droplist,entity_droplist ){

				var material;

				watch( entity_droplist, "onchange", function( property, event, value ){
					material = getMaterialByEntityId( value );
				});

				function update_material_color( key, action, value ){
					debugMode && console.log({key:key,value:value}); // debug!
					if (material && material[key]) material[key].copy(value);
					if ( color_droplist.value === key ) {
						color_r.value = (255*value.r).toFixed(0);
						color_g.value = (255*value.g).toFixed(0);
						color_b.value = (255*value.b).toFixed(0);
					}
				}

				watch( editor, "color", update_material_color );
				watch( editor, "emissive", update_material_color );
				watch( editor, "specular", update_material_color );

			})( 
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-color-r-input"),     // color_r,
				TabUI.Material.tab.querySelector("input#material-color-g-input"),     // color_g,
				TabUI.Material.tab.querySelector("input#material-color-b-input"),     // color_b,
				TabUI.Material.tab.querySelector("select#material-color-droplist"),   // color_droplist,
				TabUI.Material.tab.querySelector("select#material-entities-droplist") // entity_droplist,
			);

		//	Strings.

			(function( editor,text_input,value_input,key_droplist,type_droplist,entity_droplist ){

				var material;

				watch( entity_droplist, "onchange", function( property, event, value ){
					material = getMaterialByEntityId( value );
				});

				function update_material_value( key, action, value ){
					if ( material ) material[key] = String(value); value_input.value = "";
					if ( key_droplist.value === key ) text_input.value = value; // display.
				}

				watch( editor, "name", update_material_value );
				watch( editor, "uuid", update_material_value );
				watch( editor, "linecap", update_material_value );
				watch( editor, "linejoin", update_material_value );
				watch( editor, "precision", update_material_value );
				watch( editor, "wireframeLinecap", update_material_value );
				watch( editor, "wireframeLinejoin", update_material_value );

			})( 
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-text-input"),        // text_input,
				TabUI.Material.tab.querySelector("input#material-value-input"),       // value_input,
				TabUI.Material.tab.querySelector("select#material-keys-droplist"),    // key_droplist,
				TabUI.Material.tab.querySelector("select#material-type-droplist"),    // type_droplist,
				TabUI.Material.tab.querySelector("select#material-entities-droplist") // entity_droplist,
			);

		//	Boolean.

			(function( editor,text_input,value_input,key_droplist,entity_droplist ){

				var material;

				watch( entity_droplist, "onchange", function( property, event, value ){
					material = getMaterialByEntityId( value );
				});

				function update_material_value( key, action, value ){
					if ( material ) material[key] = Boolean(value); text_input.value = "";
					if ( key_droplist.value === key ) value_input.value = value; // display.
				}

				watch( editor, "fog", update_material_value );
				watch( editor, "lights", update_material_value );
				watch( editor, "visible", update_material_value );
				watch( editor, "skinning", update_material_value );
				watch( editor, "dithering", update_material_value );
				watch( editor, "alphaTest", update_material_value );
				watch( editor, "wireframe", update_material_value );
				watch( editor, "depthTest", update_material_value );
				watch( editor, "depthWrite", update_material_value );
				watch( editor, "colorWrite", update_material_value );
				watch( editor, "clipShadows", update_material_value );
				watch( editor, "flatShading", update_material_value );
				watch( editor, "transparent", update_material_value );
				watch( editor, "morphTargets", update_material_value );
				watch( editor, "morphNormals", update_material_value );
				watch( editor, "polygonOffset", update_material_value );
				watch( editor, "clipIntersection", update_material_value );
				watch( editor, "premultipliedAlpha", update_material_value );

			})( 
				materialEditor, // editor,
				TabUI.Material.tab.querySelector("input#material-text-input"),        // text_input,
				TabUI.Material.tab.querySelector("input#material-value-input"),       // value_input,
				TabUI.Material.tab.querySelector("select#material-keys-droplist"),    // key_droplist,
				TabUI.Material.tab.querySelector("select#material-entities-droplist") // entity_droplist,
			);

		//	Numbers.

			(function( editor,text_input,value_input,key_droplist,entity_droplist ){

				const RAD2DEG = 57.29577951308232;
				const DEG2RAD = 0.017453292519943295;

				var material; // important!

				watch( entity_droplist, "onchange", function( property, event, value ){
					material = getMaterialByEntityId( value );
				});

				function update_material_value( key, action, value ){
					if ( material ) material[key] = Number(value); text_input.value = "";
					if ( key_droplist.value === key ) value_input.value = value.toFixed(2);
				}

				function update_material_constant( key, action, value ){
					if ( material ) material[key] = Number(value); text_input.value = "";
					if ( key_droplist.value === key ) value_input.value = value.toFixed(0);
				}

			//	Rad.

				watch( editor, "rotation", function( key, action, value ){
					if ( material ) material[key] = Number(value); text_input.value = "";
					if ( key_droplist.value === key ) value_input.value = (RAD2DEG*value).toFixed(1);
				});

			//	Floats.

				watch( editor, "opacity", update_material_value );
				watch( editor, "overdraw", update_material_value );
				watch( editor, "alphaTest", update_material_value );
				watch( editor, "shininess", update_material_value ); // deprecated.
				watch( editor, "bumpScale", update_material_value );
				watch( editor, "metalness", update_material_value );
				watch( editor, "roughness", update_material_value );
				watch( editor, "reflectivity", update_material_value );
				watch( editor, "refractionRatio", update_material_value );
				watch( editor, "aoMapIntensity", update_material_value );
				watch( editor, "envMapIntensity", update_material_value );
				watch( editor, "emissiveIntensity", update_material_value );
				watch( editor, "lightMapIntensity", update_material_value );
				watch( editor, "displacementBias", update_material_value );
				watch( editor, "displacementScale", update_material_value );
				watch( editor, "polygonOffsetUnits", update_material_value );
				watch( editor, "polygonOffsetFactor", update_material_value );

			//	Constants.

				watch( editor, "size", update_material_constant );
				watch( editor, "side", update_material_constant );
				watch( editor, "scale", update_material_constant );
				watch( editor, "gapSize", update_material_constant );
				watch( editor, "combine", update_material_constant );
				watch( editor, "dashSize", update_material_constant );
				watch( editor, "blending", update_material_constant );
				watch( editor, "blendSrc", update_material_constant );
				watch( editor, "blendDst", update_material_constant );
				watch( editor, "depthFunc", update_material_constant );
				watch( editor, "linewidth", update_material_constant );
				watch( editor, "vertexColors", update_material_constant );
				watch( editor, "normalMapType", update_material_constant );
				watch( editor, "blendEquation", update_material_constant );
				watch( editor, "blendSrcAlpha", update_material_constant );
				watch( editor, "blendDstAlpha", update_material_constant );
				watch( editor, "blendEquationAlpha", update_material_constant );
				watch( editor, "wireframeLinewidth", update_material_constant );

			})( 
				materialEditor, // editor,
				document.querySelector("input#material-text-input"),  // text_input,
				document.querySelector("input#material-value-input"),  // value_input,
				document.querySelector("select#material-keys-droplist"), // key_droplist,
				document.querySelector("select#material-entities-droplist") // entity_droplist,
			);

		</script>

		<script>

		//	material-needs-update.js

			(function( needs_update ){

				watch( needs_update, "onclick", function( prop, event, value ){

					var material = getMaterialByEntityId();
					if ( material ) material.needsUpdate = true;

				});

			})( TabUI.Material.tab.querySelector("div#material-needs-update") );


		//	exit-edit-mode.js

			(function(exit_button,entity_droplist,exitEditMode){

				watch( exit_button, "onclick", function( prop, event, value ){

					 exitEditMode( entity_droplist );
				});

			})( 
				TabUI.Material.tab.querySelector("div#material-exit-mode"), // exit_button,
				TabUI.Material.tab.querySelector("select#material-entities-droplist"), // entity_droplist.
				exitEditMode // function.
			 ); 

		</script>

		<script>

			TabUI.Editor.role.classList.add("active");
			TabUI.Editor.tab.classList.add("in","active");
			groundHelper.visible = !groundHelper.visible; 

			entities.add(ground);
			entities.add(groundHelper);
			entities.add(localPlayer.getObjectByName("playerhelper"));

			cameraControls.setLatLon(5.128, 270.675);
			localPlayer.controller.movementSpeed = 30;
			localPlayer.controller.center.set(-85,2,-2);


		</script>

		<script>

		//	Background.

			(function(scene,textures_entities){

				if (!scene || Number(THREE.REVISION) < 78) return;

				var urls = [
					"https://i.imgur.com/v6bjQLb.jpg", // "posx.jpg",
					"https://i.imgur.com/lwrlr6P.jpg", // "negx.jpg", 
					"https://i.imgur.com/kKUKBJg.jpg", // "posy.jpg", 
					"https://i.imgur.com/N0oZlJR.jpg", // "negy.jpg", 
					"https://i.imgur.com/x9q8z0K.jpg", // "posz.jpg", 
					"https://i.imgur.com/HYcK7Ii.jpg", // "negz.jpg"
				];

				var loader = new THREE.CubeTextureLoader();
				loader.setCrossOrigin( "anonymous" );
				loader.load( urls, function(texture){
					scene.background = texture;
					scene.background.needsUpdate = true;
					textures_entities && textures_entities.add(texture);
				});

			})( scene, textures_entities );

		</script>

		<script>

		//  Skydome.

			const skydome = (function(scene,entities,material_entities,textures_entities){

				var loader = new THREE.TextureLoader();
				loader.setCrossOrigin( "anonymous" );
				var geometry = new THREE.SphereGeometry( 2000, 64, 32 );
				var texture = loader.load( "https://i.imgur.com/xQsNP0X.jpg" );
				texture.wrapS = texture.wrapT = 1000; texture.offset.y = -0.01;
				var material = new THREE.MeshBasicMaterial({
					map:texture,transparent:true,opacity:0.8,side:1,
				});
				var dome = new THREE.Mesh( geometry, material );
				dome.scale.set(0.10,0.08,0.10); dome.name = "skydome";
				scene.add(dome); entities && entities.add(dome);
				textures_entities && textures_entities.add(texture);
				material_entities && material_entities.add(material);
				return dome;

			})(scene, entities, material_entities, textures_entities);

			skydome.rotation.set(0.005235,0,-0.0349);

		</script>

		<script>

		//  Water.

			const water = (function(renderer,camera,scene,light,textures_entities){

				var waterNormals = loadTexture("https://i.imgur.com/gd4Gr7Q.png");
				waterNormals.wrapS = waterNormals.wrapT = THREE.RepeatWrapping;
				textures_entities && textures_entities.add(waterNormals);

			//  the water effect.
				return new THREE.Water(renderer, camera, scene, {
					textureWidth:256,  textureHeight:256,
					waterNormals:waterNormals, alpha:0.9,
					sunDirection:light.position.normalize(),
					sunColor:0xffffff,  waterColor:0x001e0f,
					betaVersion:0, side:2,
				});

				function loadTexture( url, mapping) {
					var loader = new THREE.TextureLoader();
					loader.setCrossOrigin( "anonymous" );
					var texture = loader.load( url );
					if ( mapping ) texture.mapping = mapping;
					return texture;
				}

			})( renderer, camera, scene, cameraLight, textures_entities );

			const watermirror = (function( scene,water,material_entities,entities ){

				material_entities && material_entities.add(water.material);
				var material = water.material; // entities && entities.add(water); 
				var geometry = new THREE.PlaneBufferGeometry(10000, 10000, 100, 100);
				var mirror = new THREE.Mesh( geometry, material );
				mirror.add(water); mirror.name = "water mirror";
				mirror.rotation.x = -Math.PI/2; 
				mirror.position.y = -0.01;
				scene.add(mirror);

				var clock = new THREE.Clock();
				(function render(){
					var dt = clock.getDelta();
					requestFrameID = requestAnimationFrame( render );
					water.material.uniforms.time.value += Math.max(dt, 1/60);
					water.render();
				})();

				return mirror;

			})( scene, water, material_entities, entities );

		</script>

		<script>

		//	deck 0.

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=110, h=0.5, d=60, x=-2, y=-h/2, z=2.6;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "deck0";
				mesh.visible = false;
				mesh.position.set(x,y,z);
				scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, entities );

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=100, h=0.5, d=50, x=-2, y=-0, z=2.6;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "deck0_floor";
				mesh.visible = false;
				mesh.position.set(x,y,z);
				scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, entities );

		</script>

		<script>

		//	Water path.

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=2.5, h=0.5, d=200, x=-85, y=-h/2, z=100;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "water path";
				mesh.visible = false;
				mesh.position.set(x,y,z);
				scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, entities );

		</script>

	</body>
</html>
